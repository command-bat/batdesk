<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Compartilhamento de Tela - Transmissor</title>
</head>
<body>
  <h1>Compartilhamento de Tela - Transmissor</h1>
  <button id="start">Iniciar Compartilhamento</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const startButton = document.getElementById('start');
    let screenStream;

    startButton.addEventListener('click', async () => {
      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
        socket.emit('broadcaster');
      } catch (err) {
        console.error("Erro ao capturar a tela:", err);
      }
    });

    const peers = {};

    socket.on('watcher', async (id) => {
      const peerConnection = new RTCPeerConnection();
      screenStream.getTracks().forEach(track => peerConnection.addTrack(track, screenStream));

      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          socket.emit('candidate', id, event.candidate);
        }
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit('offer', id, peerConnection.localDescription);

      peers[id] = peerConnection;
    });

    socket.on('answer', (id, description) => {
      peers[id].setRemoteDescription(description);
    });

    socket.on('candidate', (id, candidate) => {
      peers[id].addIceCandidate(new RTCIceCandidate(candidate));
    });

    socket.on('disconnectPeer', id => {
      if (peers[id]) {
        peers[id].close();
        delete peers[id];
      }
    });
  </script>
</body>
</html>
